#!/usr/bin/perl -w

######################################################################
#
#  Create a new EPrints user
#
#  Usage: create_user <username> <email> <access-level>
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
# __LICENSE__
#
######################################################################

use EPrints::Database;
use EPrints::User;
use EPrints::Session;

use strict;

if( $#ARGV < 3 || $#ARGV > 4 )
{
	die "Usage: create_user <archiveid> <username> <email> <access-level> [<password>]\n";
}

my $session = EPrints::Session->new( 1 , $ARGV[0] );
exit unless( defined $session );

my $user_ds = $session->get_archive()->get_dataset( "user" );

my $valid_access_level = 0;
my $type;
foreach $type (@{ $user_ds->get_types() })
{
	$valid_access_level = 1 if( $ARGV[3] eq $type );
}

if( $valid_access_level )
{
	my $new_user = EPrints::User::create_user( $session,
	                                           $ARGV[1],
	                                           $ARGV[2],
	                                           $ARGV[3] );

	if( $#ARGV == 4 )
	{
		$new_user->set_value( "passwd" , $ARGV[4] );
print "SET: $ARGV[4]\n";
		$new_user->commit;
	}

	if( defined $new_user )
	{
		print STDERR "Successfully created new user:\n";
		print STDERR " User ID:  ".
		             $new_user->get_value( "username" )."\n";
		print STDERR " Password: ".
		             $new_user->get_value( "passwd" )."\n";
	}
	else
	{
		my $db_error = $session->get_db()->error();
		print STDERR "Error creating user: $db_error\n";
	}
}
else
{
	print STDERR "Invalid access level. Valid access levels are:\n";
	foreach (@{ $user_ds->get_types() })
	{
		print "  $_\n";
	}
}

$session->terminate();
