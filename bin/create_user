#!/usr/bin/perl -w -I/opt/eprints/perl_lib

#cjg SOME /bin scripts should skip LANG loading...
#
######################################################################
#
#  Create a new EPrints user
#
#  Usage: create_user <username> <email> <access-level>
#
######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
# __LICENSE__
#
######################################################################

use EPrints::Database;
use EPrints::User;
use EPrints::Session;

#cjg Nice Command Options
#cjg man page
use strict;

if( $#ARGV < 3 || $#ARGV > 4 )
{
	die "Usage: create_user <archiveid> <username> <email> <access-level> [<password>]\n";
}

my $session = EPrints::Session->new( 1 , $ARGV[0] );
exit unless( defined $session );

my $user_ds = $session->get_archive()->get_dataset( "user" );

my $valid_access_level = 0;
my $type;
foreach $type (@{ $user_ds->get_types() })
{
	$valid_access_level = 1 if( $ARGV[3] eq $type );
}

if( defined EPrints::User::user_with_username( $session, $ARGV[1] ) )
{
	print STDERR "User with username '$ARGV[1]' already exists.\n";
}
elsif( $valid_access_level )
{
	my $new_user = EPrints::User::create_user( $session, $ARGV[3] );

	$new_user->set_value( "username" , $ARGV[1] );
	$new_user->set_value( "email" , $ARGV[2] );
	if( $#ARGV == 4 )
	{
		$new_user->set_value( "password" , $ARGV[4] );
		$new_user->commit;
	}

	if( defined $new_user )
	{
		print "Successfully created new user:\n";
		print "       ID: ".$new_user->get_value( "userid" )."\n";
		print " Username: ".$new_user->get_value( "username" )."\n";
		print "     Type: ".$new_user->get_value( "usertype" )."\n";
	}
	else
	{
		my $db_error = $session->get_db()->error();
		print STDERR "Error creating user: $db_error\n";
	}
}
else
{
	print STDERR "Invalid access level. Valid access levels are:\n";
	foreach (@{ $user_ds->get_types() })
	{
		print "  $_\n";
	}
}

$session->terminate();
