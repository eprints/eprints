#!/usr/bin/perl -w -I/opt/eprints3/perl_lib

######################################################################
#
#  __COPYRIGHT__
#
# Copyright 2000-2008 University of Southampton. All Rights Reserved.
# 
#  __LICENSE__
#
######################################################################


=pod

=head1 NAME

B<force_config_reload> - Force the webserver to reload the configuration of this repository.

=head1 SYNOPSIS

B<force_config_reload> I<repository_id> [B<options>] 

=head1 DESCRIPTION

This command forces the webserver to reload the config files for the given repository.

This is very useful, but the webserver will only reload the config files in the "forked" versions of itself, but the origional. This will generate a major extra load each time the webserver forks of a process.

This command offers a B<temporary> solution to the problem only. You should still restart apache at some point.

All this file really does is create an empty file named .changed in the repositories own var/ directory. The main system, running in the webservers mod_perl, looks at the time this file was last modified. If this file has changed since the repository configuration was loaded then it forces a reload.

=head1 ARGUMENTS

=over 8

=item B<repository_id> 

The ID of the eprint repository to force a reload on.

=back

=head1 OPTIONS

=over 8

=item B<--help>

Print a brief help message and exit.

=item B<--man>

Print the full manual page and then exit.

=item B<--quiet>

Be vewwy vewwy quiet. This option will supress all output unless an error occurs.

=item B<--verbose>

Explain in detail what is going on.
May be repeated for greater effect.

=item B<--version>

Output version information and exit.

=back   

__GENERICPOD__

=cut

use EPrints;

use File::Copy;
use File::Find;
use strict;
use Getopt::Long;
use Pod::Usage;

my $version = 0;
my $verbose = 0;
my $quiet = 0;
my $help = 0;
my $man = 0;

GetOptions( 
	'help|?' => \$help,
	'man' => \$man,
	'version' => \$version,
	'verbose+' => \$verbose,
	'silent' => \$quiet,
	'quiet' => \$quiet
) || pod2usage( 2 );
EPrints::Utils::cmd_version( "force_config_reload" ) if $version;
pod2usage( 1 ) if $help;
pod2usage( -exitstatus => 0, -verbose => 2 ) if $man;
pod2usage( 2 ) if( scalar @ARGV != 1 ); 

our $noise = 1;
$noise = 0 if( $quiet );
$noise = 1+$verbose if( $verbose );

# Set STDOUT to auto flush (without needing a \n)
$|=1;

my $session = new EPrints::Session( 1 , $ARGV[0] , $noise );
exit( 1 ) unless( defined $session );

my $file = $session->get_repository->get_conf( "variables_path" )."/last_changed.timestamp";
unless( open( CHANGEDFILE, ">$file" ) )
{
	EPrints::Config::abort( "Cannot write to file $file" );
}
print CHANGEDFILE "This file last poked at: ".EPrints::Utils::human_time()."\n";
close CHANGEDFILE;
if( $noise > 0 )
{
	print <<END;
The repository config will be reloaded, but you should still restart apache as
soon as possible.
END
}
$session->terminate();
	
exit;
